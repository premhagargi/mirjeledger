/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict, role-based access control model centered around a single "admin" role.
 * All data manipulation and read operations for the core business collections (stocks, agents, purchases, sales)
 * are exclusively reserved for authenticated users who are designated as administrators.
 * The default security posture is to deny all access, ensuring that only explicitly granted permissions are allowed.
 *
 * ## Data Structure
 * The data is organized into flat, top-level collections. A special collection, `/roles_admin`, is used
 * to manage administrative privileges. The existence of a user's UID as a document ID within this collection
 * signifies that they are an admin. All other collections (`/stocks`, `/agents`, `/purchases`, `/sales`)
 * store the primary application data.
 *
 * ## Key Security Decisions
 * - **Admin-Only Access**: The entire database is secured by a single check: `isAdmin()`. This function
 *   verifies that a user is authenticated and has a corresponding entry in the `/roles_admin` collection.
 * - **No Public Access**: There is no publicly readable or writable data. All operations require an
 *   authenticated admin user.
 * - **Client-Side Role Management for First Admin**: To enable a smooth "first user is admin" setup, the
 *   rules allow the user with the email 'admin@example.com' to create their own role document.
 *   This is a specific exception to the general principle of not allowing client-side role modification.
 * - **Homogeneous Collections**: Each collection contains data with a uniform security requirement (admin-only).
 *   This design simplifies query rules (`list`) and ensures they are both secure and performant, avoiding
 *   "rules are not filters" issues.
 *
 * ## Denormalization for Authorization
 * Authorization is not based on per-document ownership but on a global user role. The `/roles_admin`
 * collection serves as the central, authoritative source for this role. This avoids the need for `ownerId`
 * fields or `get()` calls within rules, making them fast and simple. The model is built on the principle
 * that a single admin user manages all data.
 *
 * ## Structural Segregation
 * The architecture naturally follows the structural segregation principle by design. Since all data has the same
 * high-security requirement (admin-only), there is no mixing of public and private data within any collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has an admin role.
     * Admin status is determined by the existence of a document in the
     * `/roles_admin` collection with the user's UID as the document ID.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }


    // -------------------------------------------------------------------------
    // Role Definitions
    // -------------------------------------------------------------------------

    /**
     * @description Secures the admin role definition collection. This rule allows the
     *              designated admin user to create their own role document upon first
     *              login, enabling the application's auto-setup feature.
     * @path        /roles_admin/{userId}
     * @allow       (get) Any authenticated user checks their own role document to see if they are an admin.
     * @allow       (create, update) The user with email 'admin@example.com' creates or updates their own role document.
     * @deny        (delete) No user can delete a role from the client.
     * @principle   Enables a self-service first-admin setup while restricting role modification to the designated admin.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if false; // Listing roles is disabled for security.
      allow create, update: if isSignedIn() && request.auth.uid == userId && request.auth.token.email == 'admin@example.com';
      allow delete: if false; // Roles must be deleted server-side or in the console.
    }


    // -------------------------------------------------------------------------
    // Application Data Collections
    // -------------------------------------------------------------------------

    /**
     * @description Grants full CRUD access to admins for the master stock records.
     * @path        /stocks/{stockId}
     * @allow       (list) An admin user ('admin_abc') lists all stock items for the dashboard.
     * @deny        (get) An anonymous or non-admin user attempts to read a stock item.
     * @principle   Enforces global admin-only access for a core data collection.
     */
    match /stocks/{stockId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants full CRUD access to admins for the agent master records.
     * @path        /agents/{agentId}
     * @allow       (create) An admin user ('admin_abc') creates a new supplier agent.
     * @deny        (update) A non-admin user attempts to modify an agent's details.
     * @principle   Enforces global admin-only access for a core data collection.
     */
    match /agents/{agentId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants full CRUD access to admins for purchase transaction records.
     * @path        /purchases/{purchaseId}
     * @allow       (list) An admin user ('admin_abc') reads all purchases for a report.
     * @deny        (delete) A non-admin user attempts to delete a purchase record.
     * @principle   Enforces global admin-only access for a core data collection.
     */
    match /purchases/{purchaseId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants full CRUD access to admins for sale transaction records.
     * @path        /sales/{saleId}
     * @allow       (get) An admin user ('admin_abc') fetches a specific sale for an invoice.
     * @deny        (create) An anonymous user attempts to log a new sale.
     * @principle   Enforces global admin-only access for a core data collection.
     */
    match /sales/{saleId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}